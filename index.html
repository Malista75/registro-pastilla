
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Pradaxa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(0.6); }
        .dark input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 dark:text-blue-400">Registro de Pradaxa</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Pulsa el botón cada vez que tomes tu medicación.</p>
        </header>

        <div class="bg-yellow-100 dark:bg-yellow-900/30 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300 p-4 rounded-md mb-8" role="alert">
            <p class="font-bold">Tu ID de Usuario</p>
            <p class="text-sm">Este ID se guarda en tu navegador. Si los datos desaparecen, usa la sección de recuperación de abajo.</p>
            <div class="mt-2 flex items-center gap-2 bg-yellow-200/50 dark:bg-gray-800 p-2 rounded-md">
                <code id="userIdDisplay" class="flex-grow text-sm font-mono break-all">Cargando...</code>
                <button id="copyIdBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md text-sm">Copiar ID</button>
            </div>
        </div>

        <main>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <button id="takePillBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300 ease-in-out">
                    ¡He tomado la pastilla!
                </button>
                <button id="estimateBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300 ease-in-out">
                    Estimar Concentración
                </button>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <button id="ibuprofenBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
                    Registrar Ibuprofeno
                </button>
                <button id="alcoholBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
                    Registrar Alcohol
                </button>
            </div>

            <div id="statsSection" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8 text-center hidden">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400">Tiempo Medio</h3><p id="avgTime" class="text-2xl font-bold text-green-600 dark:text-green-400">-</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400">Desv. Estándar</h3><p id="stdDev" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">-</p></div>
            </div>
            <div id="chartSection" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-8 hidden"><h2 class="text-xl font-bold text-center mb-4">Horas entre Tomas</h2><canvas id="takesChart"></canvas></div>
            <div id="logSection" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Historial de Eventos</h2>
                <div id="loadingMessage" class="text-center text-gray-500 py-4">Cargando datos...</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="p-3 font-semibold">Tipo</th><th class="p-3 font-semibold">Fecha</th><th class="p-3 font-semibold">Hora</th><th class="p-3 font-semibold">Detalle</th><th class="p-3 font-semibold text-right">Acción</th></tr></thead>
                        <tbody id="logTableBody"></tbody>
                    </table>
                     <p id="noDataMessage" class="text-center py-8 text-gray-500 hidden">Aún no hay registros.</p>
                </div>
            </div>
             <!-- Sección para recuperar datos -->
            <div class="mt-8 border-t dark:border-gray-700 pt-6">
                 <h3 class="text-lg font-semibold text-center mb-2">¿Datos incorrectos o en blanco?</h3>
                 <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4">Pega aquí tu ID de usuario guardado para recuperar tu historial.</p>
                 <div class="flex flex-col sm:flex-row gap-2 max-w-md mx-auto">
                     <input type="text" id="recoverIdInput" placeholder="Pega tu ID de usuario aquí" class="flex-grow w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                     <button id="loadIdBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cargar Datos</button>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modales -->
    <div id="estimateModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 z-40">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl modal-content transform scale-95 max-h-[90vh] overflow-y-auto">
            <div>
                <h2 class="text-2xl font-bold text-center mb-4">Estimador de Concentración</h2>
                <div id="riskIndicator" class="hidden p-3 rounded-md mb-4 text-center">
                    <span id="riskLabel" class="text-lg font-bold"></span>
                </div>
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4" role="alert">
                    <p class="font-bold">AVISO IMPORTANTE</p>
                    <p class="text-sm">Esta es una simulación matemática con fines educativos. **NO es un consejo médico.** Consulte **SIEMPRE** a su médico.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div><label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Edad</label><input type="number" id="age" placeholder="Años" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"></div>
                    <div><label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Peso (kg)</label><input type="number" id="weight" placeholder="kg" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"></div>
                    <div><label for="sex" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sexo</label><select id="sex" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"><option value="male">Hombre</option><option value="female">Mujer</option></select></div>
                    <div><label for="serumCreatinine" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Creatinina Sérica (mg/dL)</label><input type="number" id="serumCreatinine" step="0.1" placeholder="Ej: 0.8" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div><label for="dose" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dosis (mg)</label><select id="dose" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"><option value="150">150 mg</option><option value="110">110 mg</option></select></div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-md text-center"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Función Renal Estimada (CrCl)</label><p id="crclDisplay" class="text-lg font-bold mt-1">- ml/min</p></div>
                </div>
            </div>
            <div class="h-64 md:h-80"><canvas id="estimateChart"></canvas></div>
            <div class="mt-6 flex justify-end gap-4"><button id="closeEstimateBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cerrar</button></div>
        </div>
    </div>
    
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center modal-content transform scale-95">
            <h3 id="genericModalTitle" class="text-xl font-bold mb-4"></h3>
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">Fecha y Hora</label><input type="datetime-local" id="genericTimeInput" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"></div>
            <div id="quantitySelector" class="mb-6"></div>
            <div class="flex justify-center gap-4"><button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button><button id="confirmBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button></div>
        </div>
    </div>
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center modal-content transform scale-95">
            <h3 class="text-xl font-bold mb-4 text-red-600">Eliminar Registro</h3><p class="text-gray-600 dark:text-gray-400 mb-6">¿Seguro que quieres eliminar este registro?</p>
            <div class="flex justify-center gap-4"><button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button><button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Eliminar</button></div>
        </div>
    </div>
    <div id="copiedMessage" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-md shadow-lg opacity-0 transition-opacity duration-300">ID copiado al portapapeles</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDNI_xL3YmNk6JQiHdymJeQk3FUX8H6tCk",
            authDomain: "miregistropradaxa.firebaseapp.com",
            projectId: "miregistropradaxa",
            storageBucket: "miregistropradaxa.firebasestorage.app",
            messagingSenderId: "786729810369",
            appId: "1:786729810369:web:5fed05c41a601ea5725740",
            measurementId: "G-KQET919J0D"
        };

        let db, userId, takesChart, estimateChart = null, unsubscribe = {}, takeToDelete = null;
        let allEvents = [];

        const el = (id) => document.getElementById(id);
        const appContainer = el('app-container'), userIdDisplay = el('userIdDisplay'), copyIdBtn = el('copyIdBtn');
        const takePillBtn = el('takePillBtn'), logTableBody = el('logTableBody'), avgTimeEl = el('avgTime');
        const stdDevEl = el('stdDev'), chartSection = el('chartSection'), statsSection = el('statsSection');
        const loadingMessage = el('loadingMessage'), noDataMessage = el('noDataMessage');
        const modal = el('confirmationModal'), confirmBtn = el('confirmBtn'), cancelBtn = el('cancelBtn');
        const genericTimeInput = el('genericTimeInput'), deleteModal = el('deleteConfirmationModal');
        const confirmDeleteBtn = el('confirmDeleteBtn'), cancelDeleteBtn = el('cancelDeleteBtn');
        const recoverIdInput = el('recoverIdInput'), loadIdBtn = el('loadIdBtn');
        
        const estimateBtn = el('estimateBtn'), estimateModal = el('estimateModal'), closeEstimateBtn = el('closeEstimateBtn');
        const doseInput = el('dose'), ageInput = el('age'), weightInput = el('weight'), sexInput = el('sex'), serumCreatinineInput = el('serumCreatinine'), crclDisplay = el('crclDisplay');
        const ibuprofenBtn = el('ibuprofenBtn'), alcoholBtn = el('alcoholBtn');
        const genericModalTitle = el('genericModalTitle'), quantitySelector = el('quantitySelector');
        const riskIndicator = el('riskIndicator'), riskLabel = el('riskLabel');

        let currentModalAction = null;

        function setupUserId() {
            let currentId = localStorage.getItem('pradaxaTrackerUserId');
            if (!currentId) {
                currentId = crypto.randomUUID();
                localStorage.setItem('pradaxaTrackerUserId', currentId);
            }
            userId = currentId;
            userIdDisplay.textContent = userId;
        }

        function handleLoadId() {
            const newId = recoverIdInput.value.trim();
            if (newId) {
                userId = newId;
                localStorage.setItem('pradaxaTrackerUserId', userId);
                userIdDisplay.textContent = userId;
                recoverIdInput.value = '';
                loadDataForCurrentUser();
            }
        }

        function loadDataForCurrentUser() {
            Object.values(unsubscribe).forEach(unsub => unsub());
            unsubscribe = {};
            if (!db || !userId) return;

            loadingMessage.style.display = 'block';
            logTableBody.innerHTML = '';
            noDataMessage.style.display = 'none';

            const collections = { pradaxa: 'log', ibuprofen: 'ibuprofen', alcohol: 'alcohol' };
            
            Object.entries(collections).forEach(([type, path]) => {
                const collectionRef = collection(db, `takes/${userId}/${path}`);
                const q = query(collectionRef, orderBy('timestamp', 'desc'));

                unsubscribe[type] = onSnapshot(q, (snapshot) => {
                    const newEvents = snapshot.docs.map(d => ({ id: d.id, type, path, ...d.data() }));
                    allEvents = allEvents.filter(e => e.type !== type).concat(newEvents);
                    allEvents.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                    loadingMessage.style.display = 'none';
                    updateUI(allEvents);
                }, (error) => {
                    console.error(`Error al obtener datos de ${type}:`, error);
                    loadingMessage.textContent = "Error al cargar los datos.";
                });
            });
        }

        function copyUserId() {
            navigator.clipboard.writeText(userId).then(() => {
                const msg = el('copiedMessage');
                msg.textContent = "¡ID copiado!";
                msg.classList.remove('opacity-0');
                setTimeout(() => msg.classList.add('opacity-0'), 2000);
            });
        }
        
        async function executeDelete() {
            if (!takeToDelete) return;
            try {
                await deleteDoc(doc(db, `takes/${userId}/${takeToDelete.path}`, takeToDelete.id));
            } finally {
                hideDeleteModal();
            }
        }

        function updateUI(events) {
            renderTable(events);
            const pradaxaTakes = events.filter(e => e.type === 'pradaxa');

            if (events.length === 0) {
                noDataMessage.style.display = 'block';
            } else {
                noDataMessage.style.display = 'none';
            }
            if (pradaxaTakes.length > 1) {
                statsSection.classList.remove('hidden');
                chartSection.classList.remove('hidden');
                const stats = calculateStats(pradaxaTakes);
                const stdDev = Math.sqrt(stats.variance);
                avgTimeEl.textContent = formatDuration(stats.average);
                stdDevEl.textContent = "± " + formatDuration(stdDev);
                renderChart(stats.diffs);
            } else {
                statsSection.classList.add('hidden');
                chartSection.classList.add('hidden');
            }
        }

        function renderTable(events) {
            logTableBody.innerHTML = '';
            events.forEach((event, index) => {
                if (!event.timestamp) return;
                const date = event.timestamp.toDate();
                let icon = '';
                let detail = '';
                if (event.type === 'pradaxa') {
                    icon = '💊';
                    detail = 'Pradaxa';
                } else if (event.type === 'ibuprofen') {
                    icon = '🩹';
                    detail = `Ibuprofeno ${event.quantity}mg`;
                } else if (event.type === 'alcohol') {
                    icon = '🍺';
                    detail = `Alcohol (${event.quantity_ml}ml, ${event.abv}%)`;
                }

                const row = `<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600/20">
                    <td class="p-3 font-medium text-xl">${icon}</td>
                    <td class="p-3">${date.toLocaleDateString('es-ES')}</td>
                    <td class="p-3">${date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="p-3">${detail}</td>
                    <td class="p-3 text-right"><button data-index="${index}" class="delete-btn text-red-500 hover:text-red-700 font-semibold text-sm">Eliminar</button></td>
                </tr>`;
                logTableBody.innerHTML += row;
            });
            document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', () => showDeleteModal(allEvents[button.dataset.index])));
        }

        function calculateStats(takes) {
            const diffs = [];
            for (let i = 1; i < takes.length; i++) diffs.push(takes[i - 1].timestamp.toMillis() - takes[i].timestamp.toMillis());
            if (diffs.length === 0) return { average: 0, variance: 0, diffs: [] };
            const sum = diffs.reduce((a, b) => a + b, 0);
            const average = sum / diffs.length;
            const variance = diffs.reduce((acc, val) => acc + Math.pow(val - average, 2), 0) / diffs.length;
            return { average, variance, diffs };
        }
        
        function formatDuration(ms) {
            if (isNaN(ms) || ms < 0) return "-";
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            return `${h}h ${m}m`;
        }

        function renderChart(diffs) {
            const ctx = el('takesChart').getContext('2d');
            const labels = diffs.map((_, i) => `Toma ${i + 2}`);
            const dataInHours = diffs.map(d => d / 3600000);
            if (takesChart) takesChart.destroy();
            takesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.reverse(),
                    datasets: [{ label: 'Horas desde la toma anterior', data: dataInHours.reverse(), borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.2)', tension: 0.1, fill: true }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Horas' } } } }
            });
        }
        
        function cockcroftGault(age, weight, creatinine, sex) {
            if (!age || !weight || !creatinine) return null;
            let crcl = ((140 - age) * weight) / (72 * creatinine);
            if (sex === 'female') crcl *= 0.85;
            return crcl;
        }

        function getHalfLife(crcl) {
            if (crcl > 80) return 13;
            if (crcl >= 50) return 15;
            if (crcl >= 30) return 18;
            return 27;
        }

        function calculateConcentration() {
            const age = parseFloat(ageInput.value), weight = parseFloat(weightInput.value), sex = sexInput.value, creatinine = parseFloat(serumCreatinineInput.value);
            const crcl = cockcroftGault(age, weight, creatinine, sex);

            if (!crcl || crcl <= 0) {
                crclDisplay.textContent = '- ml/min';
                if (estimateChart) estimateChart.destroy();
                return;
            }
            
            crclDisplay.textContent = `${crcl.toFixed(1)} ml/min`;
            localStorage.setItem('pradaxaUserProfile', JSON.stringify({dose: doseInput.value, age, weight, sex, creatinine}));

            const halfLifeHours = getHalfLife(crcl);
            const now = new Date();
            const last48h = new Date(now.getTime() - 48 * 3600 * 1000);
            const next24h = new Date(now.getTime() + 24 * 3600 * 1000);

            const pradaxaTakes = allEvents.filter(e => e.type === 'pradaxa').map(t => t.timestamp.toDate()).filter(t => t > last48h).sort((a, b) => a - b);
            const dataPoints = [];
            for (let time = last48h.getTime(); time <= next24h.getTime(); time += 15 * 60 * 1000) {
                let totalConcentration = 0;
                pradaxaTakes.forEach(takeTime => {
                    if (time >= takeTime.getTime()) {
                        const hoursElapsed = (time - takeTime.getTime()) / 3600000;
                        const concentration = 100 * Math.pow(0.5, hoursElapsed / halfLifeHours);
                        totalConcentration += concentration;
                    }
                });
                dataPoints.push({ x: time, y: Math.min(totalConcentration, 150) });
            }
            
            let finalRiskLevel = 0;
            const nowMs = now.getTime();

            const recentIbuprofen = allEvents.filter(e => e.type === 'ibuprofen');
            if (recentIbuprofen.length > 0) {
                const mostRecentIbu = recentIbuprofen[0];
                const hoursElapsed = (nowMs - mostRecentIbu.timestamp.toMillis()) / 3600000;
                if (hoursElapsed < 24) {
                    const maxRisk = mostRecentIbu.quantity === '600' ? 3 : 2;
                    const currentRisk = maxRisk * (1 - (hoursElapsed / 24));
                    finalRiskLevel = Math.max(finalRiskLevel, currentRisk);
                }
            }

            const recentAlcohol = allEvents.filter(e => e.type === 'alcohol');
            if (recentAlcohol.length > 0) {
                const mostRecentAlc = recentAlcohol[0];
                const hoursElapsed = (nowMs - mostRecentAlc.timestamp.toMillis()) / 3600000;
                if (hoursElapsed < 12) {
                    const grams = (mostRecentAlc.quantity_ml * (mostRecentAlc.abv / 100)) * 0.789;
                    let maxRisk = 0;
                    if (grams > 40) maxRisk = 3;
                    else if (grams > 15) maxRisk = 2;
                    else if (grams > 0) maxRisk = 1;
                    const currentRisk = maxRisk * (1 - (hoursElapsed / 12));
                    finalRiskLevel = Math.max(finalRiskLevel, currentRisk);
                }
            }
            
            const roundedRiskLevel = Math.round(finalRiskLevel);
            
            let riskInfo = { label: "SIN RIESGO AÑADIDO", className: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200' };
            if (roundedRiskLevel === 1) {
                riskInfo = { label: "RIESGO MEDIO", className: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200' };
            } else if (roundedRiskLevel === 2) {
                riskInfo = { label: "RIESGO ALTO", className: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-200' };
            } else if (roundedRiskLevel >= 3) {
                riskInfo = { label: "RIESGO MUY ALTO", className: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200' };
            }
            
            riskIndicator.className = `p-3 rounded-md mb-4 text-center ${riskInfo.className}`;
            riskLabel.textContent = riskInfo.label;
            riskIndicator.classList.remove('hidden');

            renderEstimateChart(dataPoints, now, roundedRiskLevel);
        }

        function renderEstimateChart(data, now, riskLevel) {
            const ctx = el('estimateChart').getContext('2d');
            if (estimateChart) estimateChart.destroy();
            
            const colors = [
                { border: 'rgb(16, 185, 129)', bg: 'rgba(16, 185, 129, 0.2)' },
                { border: 'rgb(245, 158, 11)', bg: 'rgba(245, 158, 11, 0.2)' },
                { border: 'rgb(239, 68, 68)', bg: 'rgba(239, 68, 68, 0.2)' },
                { border: 'rgb(159, 18, 57)', bg: 'rgba(159, 18, 57, 0.3)' }
            ];
            const selectedColor = colors[riskLevel] || colors[0];

            estimateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Concentración Relativa Estimada (%)',
                        data: data,
                        borderColor: selectedColor.border,
                        backgroundColor: selectedColor.bg,
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } }, title: { display: true, text: 'Hora' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Concentración Relativa (%)' }, max: 150 }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: { type: 'line', xMin: now, xMax: now, borderColor: 'rgb(255, 99, 132)', borderWidth: 2, label: { content: 'Ahora', enabled: true, position: 'start' } }
                            }
                        }
                    }
                }
            });
        }
        
        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('pradaxaUserProfile') || '{}');
            if (profile.dose) doseInput.value = profile.dose;
            if (profile.age) ageInput.value = profile.age;
            if (profile.weight) weightInput.value = profile.weight;
            if (profile.sex) sexInput.value = profile.sex;
            if (profile.creatinine) serumCreatinineInput.value = profile.creatinine;
        }

        function showEstimateModal() {
            loadProfile();
            estimateModal.classList.remove('hidden');
            setTimeout(() => {
                estimateModal.classList.remove('opacity-0');
                estimateModal.querySelector('.modal-content').classList.remove('scale-95');
                if (allEvents.filter(e => e.type === 'pradaxa').length > 0 && ageInput.value && weightInput.value && serumCreatinineInput.value) {
                    calculateConcentration();
                } else {
                    riskIndicator.className = 'p-3 rounded-md mb-4 text-center bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                    riskLabel.textContent = "DATOS INCOMPLETOS";
                    riskIndicator.classList.remove('hidden');
                }
            }, 10);
        }
        function hideEstimateModal() {
            estimateModal.classList.add('opacity-0');
            estimateModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => estimateModal.classList.add('hidden'), 300);
        }

        function showModal(type) {
            currentModalAction = type;
            let title = '';
            let quantityHTML = '';

            if (type === 'pradaxa') {
                title = 'Confirmar Toma de Pradaxa';
            } else if (type === 'ibuprofen') {
                title = 'Registrar Toma de Ibuprofeno';
                quantityHTML = `<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">Dosis</label>
                                <select id="ibuprofenDose" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                                    <option value="400">400 mg</option>
                                    <option value="600">600 mg</option>
                                </select>`;
            } else if (type === 'alcohol') {
                title = 'Registrar Consumo de Alcohol';
                quantityHTML = `<div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">Cantidad (ml)</label>
                                        <input type="number" id="alcoholMl" step="100" placeholder="Ej: 300" class="mt-1 w-full px-3 py-2 border rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">Graduación (%)</label>
                                        <input type="number" id="alcoholAbv" step="1" placeholder="Ej: 5" class="mt-1 w-full px-3 py-2 border rounded-md">
                                    </div>
                                </div>`;
            }
            
            genericModalTitle.textContent = title;
            quantitySelector.innerHTML = quantityHTML;

            const now = new Date();
            genericTimeInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
        }

        async function handleConfirm() {
            if (!genericTimeInput.value) return;
            confirmBtn.disabled = true;
            
            const data = { timestamp: new Date(genericTimeInput.value) };
            let collectionPath = '';

            if (currentModalAction === 'pradaxa') {
                collectionPath = 'log';
            } else if (currentModalAction === 'ibuprofen') {
                collectionPath = 'ibuprofen';
                data.quantity = el('ibuprofenDose').value;
            } else if (currentModalAction === 'alcohol') {
                collectionPath = 'alcohol';
                data.quantity_ml = el('alcoholMl').value;
                data.abv = el('alcoholAbv').value;
                if (!data.quantity_ml || !data.abv) {
                    alert('Por favor, introduce cantidad y graduación.');
                    confirmBtn.disabled = false;
                    return;
                }
            }

            try {
                await addDoc(collection(db, `takes/${userId}/${collectionPath}`), data);
            } finally {
                confirmBtn.disabled = false;
                hideModal();
            }
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        function showDeleteModal(eventData) {
            takeToDelete = eventData;
            deleteModal.classList.remove('hidden');
            setTimeout(() => { deleteModal.classList.remove('opacity-0'); deleteModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
        }
        function hideDeleteModal() {
            deleteModal.classList.add('opacity-0');
            deleteModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => { deleteModal.classList.add('hidden'); takeToDelete = null; }, 300);
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                initializeApp(firebaseConfig);
                db = getFirestore();
                
                setupUserId();
                loadDataForCurrentUser();

                copyIdBtn.addEventListener('click', copyUserId);
                loadIdBtn.addEventListener('click', handleLoadId);
                takePillBtn.addEventListener('click', () => showModal('pradaxa'));
                ibuprofenBtn.addEventListener('click', () => showModal('ibuprofen'));
                alcoholBtn.addEventListener('click', () => showModal('alcohol'));

                cancelBtn.addEventListener('click', hideModal);
                confirmBtn.addEventListener('click', handleConfirm);
                confirmDeleteBtn.addEventListener('click', executeDelete);
                cancelDeleteBtn.addEventListener('click', hideDeleteModal);
                
                estimateBtn.addEventListener('click', showEstimateModal);
                closeEstimateBtn.addEventListener('click', hideEstimateModal);
                [doseInput, ageInput, weightInput, sexInput, serumCreatinineInput].forEach(input => {
                    input.addEventListener('input', calculateConcentration);
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                appContainer.innerHTML = '<p class="text-red-500 text-center p-8">Error crítico al iniciar la aplicación.</p>';
            }
        });
    </script>
</body>
</html>
